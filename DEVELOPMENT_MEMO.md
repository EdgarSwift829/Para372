# 372手法改良版EA - 開発メモ

## 実装状況

### ✅ 実装済み機能（v1.0）

#### 基本戦略
- [x] 3本のパラボリックSAR（15分足、1時間足、4時間足）
- [x] 3本すべてが同方向を示した時のエントリー
- [x] ドテン方式の決済（逆シグナルで決済→反対ポジション）

#### 資金管理
- [x] 口座残高の2%固定リスク
- [x] ATRベースのストップロス自動計算
- [x] リスクリワード比率によるテイクプロフィット設定
- [x] ロット自動調整機能
- [x] 最小ロット制限の処理

#### エントリーフィルター
- [x] マルチタイムフレームトレンドフィルター
  - [x] 日足トレンド判定
  - [x] 4時間足トレンド判定
  - [x] 1時間足トレンド判定
- [x] 確定足のみ使用（Close[1], Close[2], Close[3]）

#### 停止機能
- [x] 負け後の休止機能
  - [x] 連敗カウンター
  - [x] 休止期間の設定（時間/バー数/日数）
  - [x] 勝ちトレードでのリセット
  - [x] 自動再開
- [x] 月末・月初停止機能

#### その他
- [x] エラーハンドリング
- [x] ログ出力
- [x] パラメータのカスタマイズ性

### ⏳ 未実装機能（v2.0以降で実装予定）

#### 経済指標フィルター
- [ ] 羊飼いのFXブログからのデータ取得
- [ ] WebRequest実装
- [ ] HTMLパース処理
- [ ] 指標ランク別のフィルタリング
- [ ] 指標前後の停止時間設定

#### 追加予定フィルター
- [ ] ADXフィルター（トレンド強度確認）
- [ ] スプレッドフィルター
- [ ] 時間帯フィルター
- [ ] エントリー間隔制限
- [ ] 1日の最大トレード数制限
- [ ] ボラティリティフィルター

#### 高度な資金管理
- [ ] 連勝時のリスク調整
- [ ] 最大ドローダウン保護
- [ ] 利益の一部出金アラート

## 技術的な実装メモ

### パラボリックSARの取得
```cpp
// 各時間足のハンドルを作成
sar15m_handle = iSAR(_Symbol, PERIOD_M15, Step15m, Maximum);
sar1h_handle = iSAR(_Symbol, PERIOD_H1, Step1h, Maximum);
sar4h_handle = iSAR(_Symbol, PERIOD_H4, Step4h, Maximum);

// バッファからデータを取得
CopyBuffer(sar15m_handle, 0, 0, 3, sar15m);
```

### ロット計算ロジック
```cpp
// リスク金額 = 口座残高 × リスク%
riskAmount = accountBalance * (RiskPercent / 100.0);

// SL幅（ポイント）= ATR × 倍率
slDistance = atrValue * ATR_Multiplier;

// ロット = リスク金額 ÷ (SL幅 × ティック価値)
lotSize = riskAmount / (slPips * tickValue / tickSize);
```

### トレンド判定ロジック
```cpp
// 上昇トレンド: Close[1] > Close[2] かつ Close[2] > Close[3]
bool uptrend = (close1 > close2) && (close2 > close3);

// 下降トレンド: Close[1] < Close[2] かつ Close[2] < Close[3]
bool downtrend = (close1 < close2) && (close2 < close3);
```

### ドテン実装
```cpp
// 買いポジション保有中に売りシグナル
if(positionType == POSITION_TYPE_BUY && sellSignal)
{
    ClosePosition();  // 決済
    OpenPosition(ORDER_TYPE_SELL);  // 即座に売りポジション
}
```

## テストチェックリスト

### ✅ コンパイルテスト
- [x] エラーなしでコンパイル完了
- [x] 警告の確認と対処
- [x] 構文チェック

### ⏳ 機能テスト（実施予定）

#### 基本動作
- [ ] チャートに正しくアタッチできる
- [ ] パラメータが正しく表示される
- [ ] ログが出力される

#### エントリーテスト
- [ ] 買いシグナルで正しくエントリー
- [ ] 売りシグナルで正しくエントリー
- [ ] トレンドフィルターが正しく機能
- [ ] ロットサイズが正しく計算される

#### 決済テスト
- [ ] ストップロスで正しく決済
- [ ] テイクプロフィットで正しく決済
- [ ] ドテン決済が正しく機能
- [ ] 損益が正しく記録される

#### フィルターテスト
- [ ] 日足トレンドフィルターが機能
- [ ] 4時間足トレンドフィルターが機能
- [ ] 1時間足トレンドフィルターが機能
- [ ] 複数フィルターの組み合わせが機能

#### 停止機能テスト
- [ ] 連敗カウンターが正しく動作
- [ ] 休止期間が正しく設定される
- [ ] 自動再開が正しく機能
- [ ] 月末・月初停止が正しく機能

#### エッジケーステスト
- [ ] 最小ロットでの動作
- [ ] 最大ロットでの動作
- [ ] 口座残高不足時の挙動
- [ ] ブローカー制限時の挙動

### ⏳ バックテスト（実施予定）

#### ショートテスト（1年）
- [ ] USD/JPY 2024年
- [ ] EUR/USD 2024年
- [ ] 基本的な収益性確認

#### ミディアムテスト（5年）
- [ ] USD/JPY 2020-2024年
- [ ] EUR/USD 2020-2024年
- [ ] 様々な相場環境での性能評価

#### ロングテスト（10年）
- [ ] USD/JPY 2015-2024年
- [ ] EUR/USD 2015-2024年
- [ ] 長期的な信頼性確認

#### 最適化
- [ ] ATR_Multiplierの最適化
- [ ] RiskRewardRatioの最適化
- [ ] SARパラメータの最適化
- [ ] ロバストネステスト

### ⏳ フォワードテスト（実施予定）
- [ ] デモ口座での3ヶ月運用
- [ ] バックテストとの乖離確認
- [ ] パラメータの微調整

## 既知の問題と制限事項

### 現在の制限
1. **経済指標フィルター未実装**
   - v2.0で実装予定
   - 現時点では重要指標時も取引を継続

2. **スプレッドフィルターなし**
   - 広いスプレッド時もエントリー可能
   - 早朝・指標時に注意が必要

3. **時間帯フィルターなし**
   - 24時間取引を継続
   - 流動性の低い時間帯も取引

### 対処方法
- 経済指標カレンダーを手動で確認
- 重要指標時はEAを一時停止
- 流動性の低い時間帯は手動監視

## パフォーマンス最適化メモ

### 処理の効率化
```cpp
// ✅ 良い例: 新しいバーでのみ処理
if(currentBarTime == lastBarTime) return;

// ✅ 良い例: 必要な範囲のみコピー
CopyBuffer(handle, 0, 0, 3, buffer);

// ❌ 悪い例: 毎ティック処理
// OnTick()で直接エントリー判定

// ❌ 悪い例: 大量のデータをコピー
// CopyBuffer(handle, 0, 0, 1000, buffer);
```

### メモリ管理
- インジケーターハンドルは必ずReleaseする
- 配列は必要最小限のサイズで宣言
- グローバル変数は最小限に

## デバッグTips

### ログ出力の活用
```cpp
// エントリー時
Print("買いポジションオープン: Lot=", lotSize, " SL=", sl, " TP=", tp);

// デバッグ時
Print("SAR15m=", sar15m[1], " SAR1h=", sar1h[1], " Close=", close1);

// エラー時
Print("エラー: ", GetLastError(), " - ", ErrorDescription(GetLastError()));
```

### ビジュアルモードでの確認
- ストラテジーテスターのビジュアルモードを使用
- エントリー・決済のタイミングを視覚的に確認
- SARの位置と価格の関係を確認

## バージョンアップ計画

### v1.1（バグフィックス版）
- 初期テストで発見されたバグの修正
- ログ出力の改善
- パフォーマンスの最適化

### v2.0（機能追加版）
- 経済指標フィルター実装
- ADXフィルター追加
- スプレッドフィルター追加

### v3.0（高度版）
- 高度な資金管理機能
- 複数通貨ペア対応
- ポートフォリオ管理

## コードレビューチェックリスト

### ✅ コーディング規約
- [x] インデントが統一されている
- [x] 変数名が分かりやすい
- [x] コメントが適切に記述されている
- [x] マジックナンバーを避けている

### ✅ エラーハンドリング
- [x] インジケーター作成のエラーチェック
- [x] データ取得のエラーチェック
- [x] 注文実行のエラーチェック
- [x] 適切なエラーメッセージ

### ✅ リソース管理
- [x] ハンドルの適切な解放
- [x] メモリリークの防止
- [x] 配列サイズの適切な管理

### ⏳ パフォーマンス（確認予定）
- [ ] 不要な計算の削減
- [ ] データコピーの最小化
- [ ] ループの最適化

## 参考資料リンク

### MQL5公式ドキュメント
- トレード関数: https://www.mql5.com/ja/docs/trading
- テクニカル指標: https://www.mql5.com/ja/docs/indicators
- 標準ライブラリ: https://www.mql5.com/ja/docs/standardlibrary

### 372手法
- 元記事: https://note.com/aimjey/n/n71b67986a455

### 経済指標データ（v2.0で使用予定）
- 羊飼いのFXブログ: https://kissfx.com/
- ForexFactory: https://www.forexfactory.com/

## 開発履歴

### 2026/02/16 - v1.0
- 初版作成
- 基本戦略実装
- 資金管理機能実装
- トレンドフィルター実装
- 停止機能実装

### 今後の予定
- 2026/02/末 - バックテスト完了予定
- 2026/03/初 - v1.1リリース予定
- 2026/04/末 - v2.0（経済指標フィルター）リリース予定

---

**作成者**: Claude (Anthropic)
**最終更新**: 2026年2月16日
**バージョン**: v1.0開発メモ
